name: Build Android APK (Capacitor)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-android:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps
        run: npm install --no-audit --no-fund --legacy-peer-deps

      - name: Build web app
        run: npm run build

      - name: Ensure Android platform
        run: |
          npm install --no-audit --no-fund @capacitor/android@^6
          npm run cap:add:android || npx cap add android
          npx cap sync android

      - name: Patch AndroidManifest with location permissions
        run: |
          MANIFEST=android/app/src/main/AndroidManifest.xml
          echo "Patching $MANIFEST"
          # Insert permissions if missing
          grep -q 'ACCESS_FINE_LOCATION' "$MANIFEST" || sed -i '1s;^;<uses-permission android:name=\"android.permission.ACCESS_FINE_LOCATION\"/>\n;' "$MANIFEST"
          grep -q 'ACCESS_COARSE_LOCATION' "$MANIFEST" || sed -i '1s;^;<uses-permission android:name=\"android.permission.ACCESS_COARSE_LOCATION\"/>\n;' "$MANIFEST"
          grep -q 'android.hardware.location.gps' "$MANIFEST" || sed -i '1s;^;<uses-feature android:name=\"android.hardware.location.gps\"/>\n;' "$MANIFEST"

      - name: Download app icon
        run: |
          mkdir -p resources
          curl -L "https://i.postimg.cc/LXRV14wV/a-beautiful-and-aest.png" -o resources/icon.png

      - name: Generate Android icons (adaptive)
        run: npx --yes @capacitor/assets generate --android --icon resources/icon.png || echo "icon generation skipped"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android build tools
        run: |
          sdkmanager --install "platform-tools" "platforms;android-34" "build-tools;34.0.0"

      - name: Build debug APK
        run: |
          cd android
          ./gradlew assembleDebug

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: neon-trace-debug.apk
          path: android/app/build/outputs/apk/debug/app-debug.apk
