name: Build Android APK (Capacitor)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-android:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps
        run: npm install --no-audit --no-fund --legacy-peer-deps

      - name: Build web app
        run: npm run build

      - name: Ensure Android platform
        run: |
          npm install --no-audit --no-fund @capacitor/android@^6
          npm run cap:add:android || npx cap add android
          npx cap sync android

      - name: Patch AndroidManifest with location permissions
        run: |
          MANIFEST=android/app/src/main/AndroidManifest.xml
          echo "Patching $MANIFEST"
          if ! grep -q 'ACCESS_FINE_LOCATION' "$MANIFEST"; then
            awk 'BEGIN{done=0} {print; if(!done && $0 ~ /<manifest[^>]*>/){
              print "    <uses-permission android:name=\"android.permission.ACCESS_FINE_LOCATION\"/>";
              print "    <uses-permission android:name=\"android.permission.ACCESS_COARSE_LOCATION\"/>";
              print "    <uses-feature android:name=\"android.hardware.location.gps\"/>";
              done=1
            }}' "$MANIFEST" > $MANIFEST.tmp && mv $MANIFEST.tmp "$MANIFEST"
          fi

      - name: Download app icon
        run: |
          mkdir -p resources
          curl -L "https://i.postimg.cc/LXRV14wV/a-beautiful-and-aest.png" -o resources/icon.png

      - name: Generate Android icons (adaptive)
        run: npx --yes @capacitor/assets generate --android --icon resources/icon.png || echo "icon generation skipped"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android build tools
        run: |
          sdkmanager --install "platform-tools" "platforms;android-34" "build-tools;34.0.0"

      - name: Configure signing (if secrets provided)
        if: ${{ secrets.ANDROID_KEYSTORE_BASE64 && secrets.ANDROID_KEYSTORE_PASSWORD && secrets.ANDROID_KEY_ALIAS && secrets.ANDROID_KEY_PASSWORD }}
        run: |
          mkdir -p android/app
          echo "Writing keystore"
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/keystore.jks
          echo "Patching build.gradle for release signing"
          # Insert signingConfigs.release and switch buildTypes.release to use it
          awk 'BEGIN{ins=0} {print $0; if(!ins && $0 ~ /^android\s*\{/){
            print "    signingConfigs {";
            print "        release {";
            print "            storeFile file(\"keystore.jks\")";
            print "            storePassword System.getenv(\"ANDROID_KEYSTORE_PASSWORD\")";
            print "            keyAlias System.getenv(\"ANDROID_KEY_ALIAS\")";
            print "            keyPassword System.getenv(\"ANDROID_KEY_PASSWORD\")";
            print "        }";
            print "    }";
            ins=1
          }}' android/app/build.gradle > android/app/build.gradle.tmp && mv android/app/build.gradle.tmp android/app/build.gradle
          sed -i 's/signingConfig signingConfigs.debug/signingConfig signingConfigs.release/g' android/app/build.gradle || true

      - name: Build APK (debug or release)
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          cd android
          if [ -n "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            ./gradlew assembleRelease
          else
            ./gradlew assembleDebug
          fi

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: neon-trace-${{ secrets.ANDROID_KEYSTORE_BASE64 && 'release' || 'debug' }}.apk
          path: |
            android/app/build/outputs/apk/release/app-release.apk
            android/app/build/outputs/apk/debug/app-debug.apk
